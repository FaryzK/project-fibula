FLOW INSPECTOR

The Flow Inspector is an alternate view of the workflow canvas page. Users toggle between the Canvas view and the Flow Inspector view using a toggle button in the toolbar. Both views live on the same page — the toggle simply switches what is rendered in the main area.

The Flow Inspector gives users a real-time view of what is happening inside each node. Documents can be seen flowing in and out of nodes as the workflow runs. For nodes that hold documents, users can see what is held and take action.


---

LAYOUT

The Flow Inspector has two main areas:

Left sidebar — a list of all nodes in the workflow, ordered topologically (following the direction of document flow). Each node row shows:
- The node name
- A colour accent matching the node's category (same colours as the canvas)
- Live count badges: number of documents currently Processing / Held / Unrouted / Failed at that node
- Clicking a node row selects it and opens its document panel on the right

Right panel — shows documents at the selected node. Tabs vary by node type:

For most nodes: Processing · Unrouted (one per output port) · Failed
For Extractor and Document Folder nodes: Processing · Held · Unrouted (one per output port) · Failed
For Reconciliation nodes: Held Documents · Unrouted (one per output port) · Failed

The Unrouted tabs are always shown for all nodes regardless of whether any unrouted documents exist, so the user can see all output ports and know which ones need connecting.

(Reconciliation nodes omit the Processing tab — documents transition through processing so briefly it is not meaningful to surface. The "Held" tab is renamed "Held Documents" for Reconciliation nodes to match the terminology used in the Reconciliation service.)

Top of the sidebar — an Orphaned section (always visible regardless of which node is selected). Clicking it opens the Orphaned documents panel in the right area.


---

PROCESSING TAB

Shows documents that are currently being processed at this node (status = processing, current_node_id = this node).

Each row shows:
- File name
- Time processing started

Documents appear at the bottom of the list as they arrive. Documents disappear automatically when they move on to the next node or become held or failed.

The list updates via polling every 2 seconds. No manual refresh required.

Empty state: "No documents currently processing."


---

HELD TAB (Extractor and Document Folder nodes)

Only shown for Extractor and Document Folder nodes.

Shows documents currently held at this node (status = held, current_node_id = this node).

Each row shows:
- File name
- Time held since
- For Extractor nodes: the hold reason (hold_all or missing mandatory fields)
- A Delete button to permanently remove the document execution

Documents appear at the bottom of the list as they become held. Documents disappear when they are released (sent to the next node) or deleted.

The list updates via polling every 2 seconds.

Empty state: "No documents held."


---

HELD DOCUMENTS TAB (Reconciliation nodes only)

Shown only for Reconciliation nodes, replacing the Processing and Held tabs.

Shows documents currently held at this reconciliation node (status = held, current_node_id = this node). These are documents that have arrived at the recon node and are waiting to be matched and reconciled. The brief processing state that occurs when a document first arrives is not surfaced — from the user's perspective, all documents in a recon node are in a held state.

Each row shows:
- File name
- Time held since
- A Delete button to permanently remove the document execution

The list updates via polling every 2 seconds.

Empty state: "No documents currently held."


---

UNROUTED TABS

A document becomes unrouted when it finishes processing at a node and exits through an output port that has no outgoing edge (i.e. nothing is connected downstream on that port).

One Unrouted tab is shown per output port of the node. The tab label is the port name (e.g. "true", "false" for IF nodes; the category label for CATEGORISATION nodes; the slot label for RECONCILIATION nodes; "output" for single-output nodes). Tabs are always visible even when empty.

Each row shows:
- File name
- Time the document became unrouted
- A checkbox for multi-select
- A Delete button per row (permanently removes the document execution)
- A Re-trigger button per row (sends the document back to the start of the workflow; see RE-TRIGGER FLOW)

Bulk actions (appear when one or more rows are selected):
- Delete selected
- Send Out selected — resumes the selected documents from the downstream node connected to that port (see SEND OUT FROM UNROUTED below)
- Re-trigger selected — sends the selected documents back to the start of the workflow (see RE-TRIGGER FLOW)

The list updates via polling every 2 seconds.

Empty state: "No unrouted documents. Connect this port to route documents forward."


---

SEND OUT FROM UNROUTED

Send Out resumes a document's journey through the workflow from the downstream node currently connected to that output port.

The original file and all metadata accumulated so far are preserved — no re-processing of previous nodes occurs. The document's existing workflow_run_id is reused so that the canvas continues to show real-time status for the resumed leg.

When Send Out is triggered:
1. The system looks up the current outgoing edges for the node's output port. If no edge exists (the port is still unconnected), Send Out is blocked and an inline message tells the user to connect the port first.
2. For each selected document, the document_execution status is set back to 'processing', unrouted_port is cleared, and execution resumes from the downstream node.
3. Documents disappear from the Unrouted tab immediately on Send Out.

Send Out is available only from the Unrouted tab (per-document via individual selection or bulk via multi-select).


---

FAILED TAB

Shows documents that failed at this node (looked up via node_execution_logs where node_id = this node and status = failed).

Each row shows:
- File name
- Time of failure
- Error message (truncated, expandable on click)
- A Delete button to permanently remove the document execution
- A Re-trigger button to re-run the document from the beginning of the workflow

The list updates via polling every 2 seconds.

Empty state: "No failed documents."


---

ORPHANED DOCUMENTS

Orphaned documents are document executions that were held at a node when that node was deleted. They are no longer attached to any active node and cannot continue through the workflow on their own.

The Orphaned panel shows all orphaned documents for the current workflow across all time.

Each row shows:
- File name
- The name of the node it was orphaned from (stored at time of deletion, since the node no longer exists)
- Time orphaned
- A checkbox for multi-select
- A Delete button per row

Bulk actions (appear when one or more rows are selected):
- Delete selected
- Re-trigger selected — opens the trigger selection modal (see Re-trigger flow below)

Empty state: "No orphaned documents."


---

NODE DELETION WARNING

When a user attempts to delete a node that has held or unrouted documents, a warning modal appears before deletion proceeds.

The warning is triggered in two ways:
- Pressing Delete / Backspace on a selected node on the canvas
- Clicking the "Delete node" button in the NodePanel sidebar

The modal shows, separately:
- How many documents are currently held at this node (if any)
- How many documents are currently unrouted at this node (if any)
- A note that processing documents will be allowed to complete naturally; if they later reach the deleted node they will fail and appear in the Failed tab of the orphaned section
- "If you proceed, all held and unrouted documents will be moved to Orphaned Documents."

Actions in the modal:
- Cancel — dismiss and keep the node
- Proceed — delete the node and move all held and unrouted documents to orphaned status

If the node has no held or unrouted documents, deletion proceeds immediately without a warning (existing behaviour).

When held or unrouted documents are orphaned due to node deletion:
- Their document_executions status is set to 'orphaned' and they appear in the Orphaned panel
- Their extractor_held_documents records (if any) are deleted so they no longer appear in the extractor's Held tab
- For RECONCILIATION nodes: their reconciliation_held_documents records are also deleted (see RECONCILIATION NODE DELETION)


---

EXTRACTOR NODE RECONFIGURATION WARNING

When a user changes the extractor assigned to an EXTRACTOR node (switching from extractor A to extractor B), the system checks whether the current extractor has any held documents.

If held documents exist, a warning modal appears before the change is saved:
- Shows how many held documents exist for the current extractor
- Notes that any documents held at this node will be moved to Orphaned Documents

Actions in the modal:
- Cancel — dismiss and keep the current extractor; no change is made
- Proceed — save the new extractor and move any held documents at this node (for the old extractor) to orphaned status

When held documents are orphaned due to extractor reconfiguration:
- Their document_executions status is set to 'orphaned' and they appear in the Orphaned panel
- Their extractor_held_documents records are deleted so they no longer appear in the extractor's Held tab

If the current extractor has no held documents, the change saves immediately without a warning.


---

RECONCILIATION NODE RECONFIGURATION WARNING

When a user changes the extractor assigned to an existing slot in a RECONCILIATION node (switching from extractor A to extractor B), or removes a slot entirely, the system checks whether any held documents exist for that slot at this node.

If held documents exist for the affected slot, a warning modal appears before the change is saved:
- Shows how many held documents exist for that slot at this node
- Notes that those documents will be moved to Orphaned Documents and removed from the reconciliation data pool and any matching sets they belong to

Actions in the modal:
- Cancel — dismiss and keep the current slot configuration; no change is made
- Proceed — save the change and orphan any held documents for that slot

Since reconciliation node slots auto-save immediately when the user changes a dropdown (per-slot save, not whole-node save), the warning is triggered per slot at the point of each change.

When held documents are orphaned due to slot reconfiguration or removal:
- Their document_executions status is set to 'orphaned' and they appear in the Orphaned panel
- Their reconciliation_held_documents records are deleted so they no longer appear in the reconciliation Held Documents tab or Data Pool
- Their reconciliation_matching_set_docs entries are removed and any affected matching sets are cleaned up

If no held documents exist for the affected slot, the change saves immediately without a warning.


RECONCILIATION NODE DELETION

When a RECONCILIATION node is deleted, the standard node deletion warning applies (see NODE DELETION WARNING above). In addition to the standard orphaning of document_executions, the following reconciliation-specific cleanup occurs:

- All reconciliation_held_documents records for this node are deleted, removing those documents from the reconciliation Held Documents tab and Data Pool
- Their reconciliation_matching_set_docs entries are removed and any affected matching sets are cleaned up

This cleanup happens whether or not the user was warned (i.e. even if the node had no held document_executions but did have reconciliation data pool records, the pool records are removed).


---

OUTPUT PORT CHANGE WARNING

When a node's output port is changed or removed — because the port ID changes — the system checks whether any unrouted documents exist for the affected port at this node.

Output ports change ID when:
- A CATEGORISATION node's category label is renamed or deleted
- A SWITCH node's case value is renamed or deleted
- A RECONCILIATION node's slot extractor is changed or the slot is removed (the output port ID is tied to the slot ID)

If unrouted documents exist for the old port, a warning modal appears before saving:
- Shows how many unrouted documents exist for that port
- Notes that those documents cannot be routed forward and will be moved to Orphaned Documents

Actions in the modal:
- Cancel — dismiss; no change is saved
- Proceed — save the change and move the unrouted documents to orphaned status

When unrouted documents are orphaned due to an output port change:
- Their document_executions status is set to 'orphaned' and they appear in the Orphaned panel
- For RECONCILIATION nodes: because unrouted reconciliation documents have already been sent out by the reconciliation service (they are no longer held), their reconciliation_held_documents records are also deleted and any matching set membership is cleaned up

If no unrouted documents exist for the affected port, the change saves immediately without a warning.


---

RE-TRIGGER FLOW

Re-triggering sends a document back into the workflow from the beginning. The original file stored in Supabase Storage is reused — no re-upload is required.

If the workflow has exactly one trigger node (Manual Upload or Webhook), the re-trigger starts immediately with no additional prompt.

If the workflow has more than one trigger node, a modal appears for the user to choose which trigger(s) to send the document(s) to. The user can select multiple triggers (multi-select checkboxes). Each selected trigger will receive the document as if it had been uploaded there manually.

Re-trigger is available from:
- The Failed tab (per-document Re-trigger button)
- The Orphaned panel (per-document Re-trigger button, or bulk Re-trigger for selected documents)

When a document is re-triggered from the Orphaned panel, it is immediately removed from the Orphaned panel (its document_execution status is set to 'completed'). The new workflow run creates fresh document_execution records that track the document's new journey through the workflow.


---

DATA MODEL

document_executions gains two new status values: 'orphaned' and 'unrouted'

New columns on document_executions:
- orphaned_node_name (TEXT, nullable) — stores the name of the deleted node when status='orphaned', so it can be displayed in the Orphaned panel even though the node no longer exists
- unrouted_port (TEXT, nullable) — stores the output port ID the document exited through when status='unrouted', used to query which Unrouted tab the document belongs to

When a document finishes processing at a node and exits through a port with no outgoing edges:
- status → 'unrouted'
- current_node_id → this node (unchanged)
- unrouted_port → the port ID it tried to exit through

When a node is deleted and it has held or unrouted documents, those document_executions are updated:
- status → 'orphaned'
- current_node_id → null
- orphaned_node_name → node name at time of deletion

When an unrouted document is sent out (resumed):
- status → 'processing' at the downstream node
- current_node_id → downstream node
- unrouted_port → cleared (null)

node_execution_logs gains one new status value: 'unrouted', written when the document becomes unrouted at a node. This allows the node log entry to reflect the terminal state of the document at that node.


---

NODES THAT CAN HOLD DOCUMENTS

The Held tab is only shown for these node types:
- EXTRACTOR
- DOCUMENT_FOLDER
- RECONCILIATION

For all other node types the Held tab is hidden entirely.
