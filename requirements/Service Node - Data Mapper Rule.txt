There are 5 classes of nodes, and each class has a different usage. This document covers the service node - data mapper.

Trigger node
Example: manual upload

Pure execution node
Example: transform JSON, evaluate expression

Config node
Example: define system prompt once and reuse

Service node
Example: reconciliation dashboard showing matched documents, extractor node, data mapper

Webhook node (mainly used for sending events when something happens)

HTTP node (mainly used for exporting data)


---

DATA MAPPER NODE (Canvas)

The data mapper node enriches document metadata by looking up values in a reference table (data map set) and writing the matched values back into the document's extracted schema. It is useful for standardising data — for example, deriving a vendor code from a vendor name, or populating SKU codes from a product description lookup.

When a document with extracted metadata passes through the node, the configured rule runs, enriches the metadata, and outputs the document with updated field values.

Node Configuration
When placing a data mapper node on the canvas, the user selects a data map rule from a dropdown. The rule determines which extractor schema the node expects, what lookup to perform, and which fields to update.

The rule page shows a list of all canvas nodes using it, with navigation links to the relevant workflows.


---

DATA MAPPER SERVICE

The Data Mapper tab on the landing page has two sub-views: Data Map Sets and Data Map Rules.

Data Map Sets List
Displayed as a table with columns: Name, Rows, Columns, Rules, Updated by, Updated at, Actions.
- Name: clickable, navigates to the set detail/edit page.
- Rows: number of records in the set.
- Columns: number of column headers.
- Rules: number of data map rules referencing this set. Clickable — opens a dialog listing the referencing rules with links to each rule's edit page.
- Updated by: name of the user who last modified the set.
- Updated at: timestamp of the last modification.
- Actions: Edit (navigate to set page), Download CSV, Delete. Delete is disabled if the set is referenced by any rule (tooltip shows count).

Data Map Rules List
Displayed as a table with columns: Name, Nodes, Updated by, Updated at, Actions.
- Name: clickable, navigates to the rule edit page.
- Nodes: number of workflow nodes using this rule. Clickable — opens a dialog listing the workflows and node names with links that navigate to the canvas with the node focused.
- Updated by: name of the user who last modified the rule.
- Updated at: timestamp of the last modification.
- Actions: Edit (navigate to rule page), Delete. Delete is disabled if the rule is used by any node (tooltip shows count).


---

DATA MAP SETS

A data map set is a reference table used for lookups. Examples: Vendor Master Data, SKU Conversion List, Currency Exchange Rates.

Each set has a name and an ordered list of typed column headers. Each header has a name and a data type (string, number, boolean, date, currency). Each record is a row of values keyed by those column headers.

Creating a Data Map Set
Users create a new set by uploading a CSV or JSON file:
- CSV: first row is treated as column headers; remaining rows become records
- JSON: expects an array of objects; keys become column headers

After upload, the system detects column headers from the file. The user assigns a data type to each column (string, number, boolean, date, currency) via a dropdown. The user also enters a set name. On submit, the system validates all record values against the declared data types. Type mismatches are reported as errors. Duplicate rows (exact match on all values after coercion) are automatically removed, and the count of removed duplicates is shown.

Viewing a Data Map Set
The default view is read-only. It shows:
- Set name and column headers with data type badges
- Paginated record table (page size selector: 25, 50, 100)
- Per-column filters: text search for string and currency columns, range inputs for number and date columns, toggle for boolean columns
- Download CSV button — exports the full set as a CSV file
- Delete button — disabled with tooltip if the set is referenced by any rule

Editing a Data Map Set
Users toggle between View and Edit mode. In Edit mode:
- Set name is editable
- Column headers and data types are NOT editable (immutable after creation)
- Cell values are inline-editable with type validation on blur
- Users can add a single row manually
- Users can bulk-add rows by uploading another CSV or JSON file. New rows are validated against the existing column types. Duplicates (against existing + new rows) are removed.
- Users can delete individual rows

Delete Protection
A data map set cannot be deleted if it is referenced by any data map rule. The delete button is disabled and shows a tooltip listing the referencing rules.


---

DATA MAP RULES

A data map rule defines how to enrich a document's extracted metadata using a single data map set.

Creating a Rule
Each rule has:
- Rule name
- Extractor schema: which extractor's schema this rule targets. The schema determines the available header fields and table columns when configuring lookups and targets.
- Data Map Set: the single reference table used for all lookups and targets in this rule.

A rule consists of two parts: Lookup Criteria and Map Targets.

1. Lookup Criteria
Defines how to find the correct row in the rule's data map set. Users add one or more lookup conditions (up to 7). Each condition:
- Selects a set column to match against (from the rule's data map set)
- Selects a schema field (header field or table column) whose extracted value to compare
- Sets match type: Exact Match or Fuzzy Match (with a configurable similarity threshold, default 80%)

All lookup conditions are applied with AND logic — a candidate record must satisfy all conditions to be considered. When multiple records qualify, the one with the highest combined similarity score is selected.

Table column schema fields are referenced as "TableType.ColumnName" (e.g. "Invoice Items.Description"). Header fields are referenced by name directly (e.g. "VendorName").

2. Map Targets
Defines which schema fields to populate from the matched record. Each target has:
- Target field: which schema field to write to (header field or table column)
- Value: a token-based expression defining what value to write

The expression is a sequence of typed tokens. Each token is one of:
- Set column (amber chip): a column from the data map set — resolved from the matched record
- Extractor field (indigo chip): a field from the extractor schema — resolved from the document's extracted metadata
- Operator (gray chip): arithmetic operator (+, -, *, /, (, ))
- Literal (green chip): a user-entered constant value (number or text)

Expression Builder UI
The value is displayed as a row of colored chips. Users build expressions by clicking chip buttons:
- Set column chips (amber): one for each column in the rule's data map set. Clicking appends a set token.
- Extractor field chips (indigo): all header fields and table columns from the extractor schema. Clicking appends an extractor token.
- Operator buttons: +, -, *, /, (, ). Clicking appends an operator token.
- Literal input: a text field with an "Add" button for entering constant values.
Each token in the expression has a small × button to remove it.

Examples:
- [set: VendorCode] — simple map: copy VendorCode from matched record
- [ext: Invoice Table.Qty] [*] [set: conversion] — multiply the extracted quantity by the matched conversion factor
- [ext: Invoice Table.Unit Price] [/] [set: conversion] — divide the extracted unit price by the conversion factor
- [ext: Invoice Table.Quantity] [*] [lit: 2] — multiply quantity by a literal constant

Header vs Table Target Behaviour
- Header targets (schema field has no dot): the lookup runs once using the document's header field values. The matched record's value is written to the specified header field.
- Table column targets (schema field has dot, e.g. "Invoice Items.Quantity"): the lookup runs once per row in the specified table. For each row, the lookup uses that row's column values to find a matching record, then writes the target value back into that row. Rows with no matching record are left unchanged.

A single rule can have both header targets and table column targets. Each block runs independently using the same lookup criteria.


---

EXAMPLE: UoM Normalisation

Scenario: Vendor invoices have line items in mixed units (BOX, PCS). The business wants all quantities normalised to PCS before downstream processing.

Data Map Set — "UoM Conversion":
| from_uom | to_uom | conversion |
|----------|--------|------------|
| PCS      | PCS    | 1          |
| BOX      | PCS    | 10         |

Invoice Extractor Schema — table columns: Item, UoM, Qty, Unit Price, Total

Rule Setup:
- Rule name: Invoice UoM PCS Normalisation
- Extractor: Invoice
- Data Map Set: UoM Conversion

Lookup Criteria:
  Set column: from_uom ↔ Schema field: Invoice Table.UoM (Exact Match)
  → Per line item, finds the row where from_uom matches the item's UoM.

Map Targets:
| Target field              | Value expression                                        | Effect                                      |
|---------------------------|---------------------------------------------------------|---------------------------------------------|
| Invoice Table.UoM         | [set: to_uom]                                           | Maps UoM to target unit (BOX → PCS)         |
| Invoice Table.Qty         | [ext: Invoice Table.Qty] * [set: conversion]            | Multiplies quantity by conversion factor     |
| Invoice Table.Unit Price  | [ext: Invoice Table.Unit Price] / [set: conversion]     | Divides unit price by conversion factor      |

How it works in the flow:
1. Document passes through the Extractor node → extracts line items
2. Document reaches the Data Mapper node → runs the rule per row:
   - Line item "Gloves, BOX, 1, 50, 50":
     Lookup finds from_uom=BOX → to_uom=PCS, conversion=10
     UoM: BOX → PCS | Qty: 1 * 10 = 10 | Unit Price: 50 / 10 = 5 | Total unchanged: 50
   - Line item "Pen, PCS, 5, 1, 5":
     Lookup finds from_uom=PCS → to_uom=PCS, conversion=1
     UoM: PCS → PCS | Qty: 5 * 1 = 5 | Unit Price: 1 / 1 = 1 | Total unchanged: 5
3. Enriched document continues downstream with normalised quantities


---

Node Usage List
The rule edit page shows all canvas nodes currently using this rule across all workflows. Clicking an entry navigates directly to that node on the canvas.
