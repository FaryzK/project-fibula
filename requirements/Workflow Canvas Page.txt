The workflow canvas page can be accessed from the workflow tab. The workflow tab shows a list of workflows created by the user, and its workflow name. Workflows can be deleted, published or unpublished. A workflow can be renamed. Users can click the Add Workflow button to start creating a new workflow. They will be directed to the workflow canvas page.

The workflow canvas page allows the user to build a document processing workflow by placing down nodes and linking them together. Each node takes an expected input and produces an output. Some nodes also provide services to users (document folder node, reconciliation node, extractor node). Nodes can branch out and branch back in. Each node will run for each document that passes through it.

When a node's output port has exactly one outgoing edge, the document continues along that single path as the same execution. When a node's output port has two or more outgoing edges (multi-edge fan-out), the engine creates one independent child document per branch — each child is a distinct document record with its own file URL (copied from the source) and its own document_id. The source document becomes the parent; children reference it via parent_document_execution_id. Branch names are baked into the file name (e.g. invoice(1).pdf, invoice(2).pdf). Each child is fully independent: deleting one branch never affects the others. This allows each branch to reach its own terminal state (completed, held, unrouted, or failed) without interfering with the others.

When a node's output port has no outgoing edge and no reconciliation release, the document becomes "unrouted" — it stops there and is recorded with status=unrouted in the Flow Inspector and on the Reconciliation page's Unrouted tab.

2 nodes can also connect back into one node — in this case documents simply flow into it from both paths.


---

CANVAS NAVIGATION

Users can pan the canvas by holding left click on an empty area and dragging. Zoom in and out with the scroll wheel or trackpad pinch.

Nodes can be repositioned by holding left click on a node and dragging it. Position is persisted to the backend when the drag ends.

By holding shift and clicking or drawing a selection box, users can multi-select nodes and reposition them together. Selected nodes deactivate when the user clicks on an empty area without shift.

A minimap and zoom controls are shown in the bottom-left corner of the canvas.


---

ADDING NODES

Users can add a node by pressing the + button in the top-right toolbar. This opens a right sidebar (node palette) listing all available node types, searchable by name.

Clicking a node in the palette places it at the center of the current viewport. An anti-collision strategy is applied: if a node already exists at that position, the new node steps rightward and upward until a free position is found.

Nodes can also be added by dragging them from the palette onto the canvas at a specific position.


---

LINKING NODES

Nodes are connected by dragging from an output handle (right side of a node) to an input handle (left side of another node). While dragging, an arrow follows the mouse. If the user releases the mouse on the canvas background (not on a node), the node palette opens with a pending connection — selecting a node type from the palette creates the node and immediately connects it.

Clicking on an existing edge/link shows a confirmation prompt to delete it.

A node can have multiple input ports and multiple output ports. Multi-output nodes (e.g. IF, SWITCH, CATEGORISATION, RECONCILIATION) show labeled port rows on the right side of the node. Multi-input nodes (e.g. RECONCILIATION) show labeled port rows on the left side.

An output handle that has two or more edges connected to it is a fan-out handle. Documents reaching that port will be cloned into independent child executions, one per edge. The canvas should visually indicate this — for example with a small "⑂" or "×N" badge on the handle — so the user understands that branching from that handle will duplicate the document rather than split it along mutually exclusive paths.


---

NODE PANEL (CONFIGURATION)

Double-clicking a node opens its configuration panel as a right sidebar. The panel shows the node name (editable), its configuration options, and — if a run has been executed — the last run's input and output metadata for that node.

Closing the panel returns the user to the canvas. If a node is navigated to via a deep link (?node=:nodeId in the URL), the canvas centres on that node and opens its panel automatically.


---

TOOLBAR

The top toolbar contains:
- Back button: returns to the workflows list
- Workflow name: click to rename inline
- Run button: opens the Run modal to trigger a manual run
- Published / Unpublished badge: shows current publish state
- Publish / Unpublish button: toggles publish state
- + button: opens the node palette


---

RUN MODAL

When the user clicks Run, a modal appears. The modal shows one file picker per MANUAL_UPLOAD node in the workflow (labeled with the node name). If there are no MANUAL_UPLOAD nodes, a single generic file picker is shown.

The user selects one or more files (PDF, PNG, JPG, JPEG, TIFF) per trigger node. Files are not required for every node — any node left empty is simply skipped. Clicking Start Run uploads the files and triggers execution.

Accepted file types: .pdf, .png, .jpg, .jpeg, .tiff, .tif


---

EXECUTION STATUS VISUALISATION

Once a run starts, the canvas shows live status on each node via a badge in the top-right corner of the node:

- ⟳ (amber) — node is currently processing a document
- ✓ (green) — all documents through this node completed successfully
- ✕ (red) — one or more documents failed at this node
- ⏸ (orange) — a document is held at this node (e.g. extractor hold_all, document folder)

Reconciliation nodes show ✓ instead of ⏸ when holding documents, because holding is its normal operating behaviour — documents are not in error, they are awaiting reconciliation.

The badge also shows a document count (e.g. ✓ 3) indicating how many documents have passed through.

Output port handles (right side of the node) are coloured:
- Indigo — no run has been triggered yet (default)
- Green — at least one document exited through this port during the current run
- Grey — the run is active but no document has exited through this port yet

This allows the user to see which branch was taken on a multi-output node (e.g. which CATEGORISATION label was assigned, which IF branch fired).

Edges/links are animated green only on the specific source port that carried data. If a multi-output node has two ports and only one carried data, only the edge from that port animates; the other stays static.

The status display is updated by polling every 2 seconds. An immediate poll fires when the run starts to capture fast-completing nodes without delay. Polling stops automatically when the run reaches a terminal state (completed or failed).

A status banner appears at the top of the canvas during and after a run:
- Amber: run in progress
- Green: run completed
- Red: run failed or upload error

The banner has a Dismiss button to clear it.


---

EXECUTION MODEL

Edge routing rules per output port:
- 0 edges → document is marked unrouted (status=unrouted). Visible in Flow Inspector's Unrouted tab and the Reconciliation page's Unrouted tab.
- 1 edge → same document_execution row continues downstream (most common case).
- 2+ edges → one independent child document is created per branch. The source file is copied in storage and a new documents row is created for each branch (new document_id, new file URL). The branch file name encodes its position: invoice.pdf → invoice(1).pdf, invoice(2).pdf. Each child exec references the source via parent_document_execution_id. The parent exec is marked completed. Children run sequentially to preserve reconciliation ordering.

Document splitting fanout (SPLITTING node) works the same way at the storage level — it also creates new document records with new file URLs, one per sub-document — but the motivation and content differ. Multi-edge fan-out produces identical copies of the source file, one per branch edge (topology-driven). SPLITTING produces distinct sub-documents with different content (e.g. different page ranges), extracted from the source by the splitting instruction (instruction-driven). Both fanout children are run sequentially to prevent TOCTOU races when sub-documents converge at a reconciliation node.

Documents are processed sequentially in the outer execution loop. This prevents race conditions in the reconciliation node, which needs to check whether sibling documents have all reached held state before releasing them.

In a published workflow, each document upload creates its own workflow run and is fully independent. Race conditions do not apply in this case because each run has exactly one document in its execution queue at the start.

The sequential outer loop only matters when multiple documents are uploaded together in a single manual run.

On server startup, any document_executions left in 'processing' status and any workflow_runs left in 'running' status from a previous server session are automatically marked as 'failed'. This handles the case where the server was restarted or crashed mid-execution, preventing ghost documents from appearing in the Flow Inspector or canvas status badges.


---

NODE VISUAL DESIGN

Each node is displayed as a rounded card with:
- A colour accent bar at the top (colour indicates node category: blue = Trigger, purple = Config, amber = Execution, green = Service, red = Output)
- A category label (e.g. "Trigger", "Service")
- The node name
- A run status badge (when a run is active)
- Input handles on the left, output handles on the right
- For multi-port nodes: labeled port rows aligned to their handles

Node categories:
- Trigger: Manual Upload, Webhook
- Config: Document Splitting, Document Categorisation
- Execution: IF, SWITCH, Set Value
- Service: Extractor, Data Mapper, Reconciliation, Document Folder
- Output: HTTP


---

KEYBOARD SHORTCUTS

- Delete / Backspace: deletes all selected nodes (when focus is not on an input field)
