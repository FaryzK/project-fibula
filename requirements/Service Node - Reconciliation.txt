There are 5 classes of nodes, and each class has a different usage. This document covers the service node - reconciliation node.

Trigger node
Example: manual upload

Pure execution node
Example: transform JSON, evaluate expression

Config node
Example: define system prompt once and reuse

Service node
Example: reconciliation dashboard showing matched documents, extractor node, data mapper

Webhook node (mainly used for sending events when something happens)

HTTP node (mainly used for exporting data)


---

RECONCILIATION NODE (Canvas)

The reconciliation node is a type of service node that reconciles documents against a set of rules defined by the user.

Node Configuration (Slot-Based)
The reconciliation node does NOT hold a reference to a reconciliation rule. Instead, the node is configured with a list of extractor slots — one per document type expected. For example, a node processing PO + Invoice + Credit Note would have three slots, each labeled with the extractor name.

On the canvas, each slot appears as a labeled input port. The user connects the appropriate upstream extractor or processing node to the correct labeled port. This tells the system which document is which as it arrives at the node.

All documents arriving at the node are held regardless of type. The node has one output port per input slot; documents exit only when fully reconciled (all comparisons resolved for at least one variation).

If a document is not successfully reconciled, it remains held inside the reconciliation service until it is resolved or manually removed.


---

RECONCILIATION SERVICE

The reconciliation service manages rules, matching sets, and the comparison lifecycle independently of the node.

1. Creating a New Rule

On the Reconciliation landing page, users can view existing rules or press New Rule. When creating a rule, the user defines:

- Rule name
- Anchor extractor: the primary document type that acts as the source of truth (e.g. Purchase Order). One matching set is created per anchor document.
- Target extractors: the other document types expected alongside the anchor (e.g. Invoice, Credit Note). Multiple targets can be defined.
- Auto send-out toggle: if enabled, the system automatically sends out the anchor document the moment all comparisons for at least one variation are resolved. If disabled, the user manually triggers send-out.

2. Defining Variations

A reconciliation rule contains one or more Variations. All variations run in parallel — the system does not fall back from one to another. The user can freely toggle between variation results in the UI.

Each variation is an independent end-to-end setup that defines three things:

Step A: Header Linking (Finding Documents)
Defines how documents in the same matching set are linked at the document (header) level. Links are defined by pairing fields across document types.

- Example: link PO.PO_Number to Invoice.Order_Reference
- Links can be transitive: PO ↔ Invoice via PO#, then Invoice ↔ Credit Note via Invoice Number. There is no requirement for a direct PO ↔ Credit Note link.
- A link can require an Exact Match or a Fuzzy Match (with a configurable percentage threshold to handle typos, e.g. "Acme Corp" vs "Acme Corporation").

Step B: Table Column Normalisation (Row Matching)
Defines how to align rows across tables in linked documents.

- The user maps column identifiers across document types. Example: PO_table.Part_Number ↔ Invoice_table.Item_SKU.
- A document can have multiple table types. A table type groups rows from multiple physical page tables of the same schema so that they appear as one unified table.
- Keys can be chained: PO ↔ Invoice via Item Code, Invoice ↔ Credit Note via Item Code. No direct PO ↔ Credit Note key is required.

Step C: Comparison Expressions (Evaluating Data)
After documents and rows are linked, the system evaluates comparison expressions. Comparisons are grouped into two levels:

Header-Level Comparison
Compares document-wide fields. Expressions reference extractor fields using dot notation:

  Extractor Name.FieldName

Example: (Invoice.Grand_Total - Credit_Note.Credit_Total) == PO.Grand_Total

Table-Level Comparison
Compares row-level values aligned via Step B. Expressions use three-part dot notation:

  Extractor Name.TableName.ColumnName

Example: PO_Extractor.PO_table.Total == Invoice_Extractor.Invoice_Table.Total - Credit_Note_Extractor.Credit_Note_Table.Amount

Missing rows: if a non-anchor document has no matching row for a given anchor row, all column values for that document default to 0 in the comparison. This means a formula like PO.total = Invoice.total - CreditNote.total still evaluates correctly when no Credit Note row exists (CreditNote.total = 0).

Tolerances
For every comparison expression, the user can apply a tolerance:
- Absolute tolerance: accept a difference up to a fixed amount (e.g. $0.50)
- Percentage-based tolerance: accept a variance up to a percentage of the expected value (e.g. 1%)

A built-in floating-point epsilon (1e-9) is applied before user-defined tolerances to handle rounding artefacts in arithmetic.


---

MATCHING SETS

One matching set represents: one anchor document × one variation.

If a rule has 3 variations and 5 anchor documents have arrived, there are up to 15 matching sets (5 anchors × 3 variations). Each variation's matching set for the same anchor is evaluated independently.

When a new document arrives, the system retroactively checks the held document pool and adds any earlier compatible documents to the new document's matching set (and vice versa).

Matching Set Lifecycle
- Comparisons within a set are evaluated automatically when all required documents are present.
- Comparisons can be re-evaluated at any time using the Re-evaluate action.
- An anchor document is considered fully reconciled when at least one variation's matching set has all comparisons resolved (auto or force).
- Once fully reconciled (and auto send-out is on), or once the user manually sends out the anchor, the document exits the node.


---

COMPARISON STATES

Each individual comparison (header field or table row) has one of three states:

- Pending: the comparison has not yet been resolved (values do not match within tolerance, or documents are still missing).
- Auto: the system automatically resolved the comparison (values matched within tolerance).
- Force: the user manually approved the comparison despite it not meeting the tolerance threshold.

Actions available per comparison:
- Force reconcile: user approves a pending comparison. Updates its state to Force.
- Reject: removes the target document from all matching sets globally and marks it as rejected. If the anchor document is rejected, it is also removed at the anchor level.
- Leave pending: no action; wait for a better document to arrive (e.g. a corrected invoice).

Once all comparisons in a matching set are either Auto or Force, the documents in that set are eligible for send-out.


---

DOCUMENT STATES

Documents in the reconciliation service have one of three statuses:

- Held: in the system, not yet reconciled or sent out.
- Reconciled: the anchor has been sent out. A copy of the record is kept so other rules can still reference it as a target document.
- Rejected: removed from all matching sets. If it was an anchor, it is also marked rejected at the anchor level.

A document can be the anchor in one rule and a target in another simultaneously.

Many-to-Many Document Relationships
Documents can participate in multiple rules at the same time. For example, an Invoice might be the anchor in an "Invoice ↔ Credit Note" reconciliation rule while also being a target document in a "PO ↔ Invoice" rule. Sending out (reconciling) a document in one rule does not remove it from other rules — its status becomes Reconciled, but it remains visible and usable as a target in any other rule that references it. This allows the same physical document to be reconciled independently across multiple rule contexts without needing to re-upload or duplicate it.


---

UI STRUCTURE (Reconciliation Tab)

The Reconciliation landing page has three sub-tabs:

1. Anchor Documents
Filtered by selected rule. Shows each anchor document and its overall status (Open / Fully Reconciled). Clicking an anchor opens its detail page.

Anchor Detail Page:
- Variation toggle at the top to switch between variations for the same anchor.
- Per variation: the matching set table (all linked documents), comparison table (header and row comparisons with their states), and action buttons (Force Reconcile / Reject / Leave Pending).
- A Re-evaluate button appears when the matching set exists and any comparison is still Pending. Clicking it re-runs all comparison expressions against current data without re-running the workflow.
- When all comparisons are Auto or Force, comparison cells are displayed in green. Pending comparisons are highlighted.
- Adding a document to a matching set: only documents already held in the reconciliation service (arrived via workflow) can be added. Uploading arbitrary files directly is not supported.

2. Held Documents
Shows only documents that are currently unreconciled — documents that have arrived via workflow but have not yet been sent out (status = held). Documents that have been sent out (reconciled) or rejected do not appear here.

Each row shows:
- Document name and status badge (always Held in this tab)
- Extractor / slot label (which document type this is, e.g. "Purchase Order")
- Source: which workflow and which reconciliation node it came from (node name shown; if node was deleted, shown as "Deleted node")
- Matching sets it belongs to: first few shown, remainder truncated with "+N more" (expandable)
- A delete button to permanently remove the document from reconciliation

Empty state: "No documents currently held in reconciliation."

3. Data Pool
Global list of all documents the reconciliation service has ever seen, across all statuses (Held, Reconciled, Rejected) and all workflows. Documents remain in the Data Pool even after being sent out — this allows them to be referenced as targets in other matching sets.

Why Data Pool exists alongside Held Documents:
In many-to-many reconciliation scenarios (e.g. multiple POs matched against multiple Invoices), a PO may be fully reconciled with one Invoice and sent out — but a separate Invoice might still be waiting for that PO's data to complete its own matching set. Blocking the PO's send-out would be wrong, but discarding its data would break the second Invoice's reconciliation. The Data Pool retains a persistent record of every document regardless of send-out status, so it remains available as a target in any matching set. Held Documents is a filtered view of the same pool — only the subset that still needs action (status = held).

Each row shows:
- Document name and status badge (Held / Reconciled / Rejected)
- Extractor / slot label
- Source: which workflow and which reconciliation node it came from
- Matching sets it belongs to: first few shown, remainder truncated with "+N more" (expandable)
- A delete button


---

RECONCILIATION NODE IN THE WORKFLOW

When a reconciliation node is added to the canvas:
- The user configures the node's extractor slots (document types it expects).
- Input ports are labeled with the extractor names. The user connects upstream nodes to the correct ports.
- Opening the node from the canvas navigates to the Reconciliation tab, filtered to that node's documents.
- Documents that exit the node (fully reconciled) carry their metadata and a "successfully reconciled" status tag, and flow to downstream nodes.
